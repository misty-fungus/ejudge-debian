#!/usr/bin/make -f
# -*- makefile -*-
#
#  Hardening: does not work! need to patch configure and makefiles
#
#  include /usr/share/hardening-includes/hardening.make
#
#  CFLAGS=$(shell dpkg-buildflags --get CFLAGS)
#  LDFLAGS=$(shell dpkg-buildflags --get LDFLAGS)
#  CFLAGS+=$(HARDENING_CFLAGS)
#  LDFLAGS+=$(HARDENING_LDFLAGS)
#

DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)

export DH_VERBOSE=1

%:
	dh "${@}" --with quilt,apache2 --without python2,pypy,python-support,python3 --parallel

.PHONY: override_dh_auto_configure
override_dh_auto_configure:
	dh_auto_configure -- \
		--disable-rpath  \
		--libexecdir=/usr/lib/$(DEB_HOST_MULTIARCH) \
		--enable-charset="UTF-8" \
		--enable-socket-path=/run/ejudge/userlist-socket \
		--enable-super-serve-socket=/run/ejudge/super-serve-socket \
		--enable-new-server-socket=/run/ejudge/new-server-socket \
		--enable-cgi-bin-dir=/usr/lib/cgi-bin \
		--enable-cgi-conf-dir=/usr/lib/$(DEB_HOST_MULTIARCH)/ejudge/cgi-data \
		--enable-ejudge-xml=/etc/ejudge/ejudge.xml \
		--enable-contests-dir=/srv/ejudge/contests \
		--enable-contests-home-dir=/srv/ejudge  \
		--enable-local-dir=/var/spool/ejudge \
		--enable-ajax \
		--enable-lang-config-dir=/var/lib/ejudge/compile/conf/lang.d \

# note: dont change /var/... to \$${localstatedir}. configure will write it to config.h as is
#       same for $${prefix}

.PHONY: override_dh_strip
override_dh_strip:
	dh_strip --dbg-package=ejudge-dbg

install_root:=$(CURDIR)/debian/ejudge
.PHONY: override_dh_auto_install
override_dh_auto_install:
	sed 's/@DEB_HOST_MULTIARCH@/$(DEB_HOST_MULTIARCH)/g' "$(CURDIR)/debian/extra/ejudge.xml.in" >"$(CURDIR)/debian/extra/ejudge.xml"
	dh_auto_install --destdir=debian/ejudge
	mkdir -p "$(install_root)/usr/sbin/"
	mv "$(install_root)/usr/bin/ejudge-control" "$(install_root)/usr/sbin/"
	mv "$(install_root)/usr/bin/ejudge-config" "$(install_root)/usr/sbin/"
	mv "$(install_root)/usr/bin/ejudge-upgrade-web" "$(install_root)/usr/sbin/"
	
	# removing extra binaries
	rm "$(install_root)/usr/sbin/uudecode"
	
	# Setup bundle dojo
	dojo_package=$$(ls $(CURDIR)/debian/extra/ | grep dojo-release-.*.tar.gz | head -n 1);\
	  tar -xzf "$(CURDIR)/debian/extra/$${dojo_package}" --directory "$(install_root)/usr/share/ejudge/style" --transform "s/^$${dojo_package%.tar.gz}\///"  --wildcards "$${dojo_package%.tar.gz}/*"


.PHONY: override_dh_auto_clean
override_dh_auto_clean:
	# bzr-builder does not support quilt packages and converts
	# quilt packages to native 
	if grep -q native debian/source/format; then \
		rm -rf .pc; \
	fi 
	dh_auto_clean
	debconf-updatepo
	rm -f .build
	rm -f style/ejudge-upgrade-web
	rm -f python/streamio/Makefile
	rm -f python/Makefile
	rm -f debian/ejudge.manpages  #remove autogenerated ejudge.manpages
	rm -f reuse/reuse_*.o
	rm -f ejudge-install.sh
	rm -f checkers/ejudgecheckers.po
	rm -rf checkers/locale/

.PHONY: override_dh_installman
override_dh_installman:
	echo debian/manpages/* | sed 's/[[:space:]]/\n/g' > debian/ejudge.manpages
	dh_installman
	dir=debian/ejudge; set -x;\
	mkdir -p $${dir}/usr/share/man/man1; \
	rm -f $${dir}/usr/sbin/ejudge-install.sh; \
	for file in $${dir}/usr/bin/* $${dir}/usr/sbin/* ; do \
		binary=$${file##*/}; \
		if [ $$binary = ejudge-install.sh ]; then \
			continue; \
		fi; \
		if [ ! -f debian/manpages/$${binary}.1 ]; then \
			if help2man $${file} >/dev/null 2>&1; then \
				help2man --name="ejudge server binary autogenerated manpage. This binary is not intended to be run by user." $${file} | gzip --best -c > $${dir}/usr/share/man/man1/$${binary}.1.gz; \
			else \
				ln -s ../man7/ejudge.7.gz $${dir}/usr/share/man/man1/$${binary}.1.gz; \
			fi; \
		fi; \
	done;

